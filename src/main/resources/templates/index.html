<!DOCTYPE html>
<html lang="tr" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DermAI - Professional Skin Care AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e'
                        },
                        gray: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'display': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS for specific components -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
        }
        
        .nav-blur {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
      }
    </style>
</head>
<body>

<!-- Professional Splash Screen -->
<div id="splash" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-primary-50 to-primary-100 transition-opacity duration-500">
    <div class="text-center">
        <div class="flex items-center justify-center mb-6">
            <div class="w-16 h-16 bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center mr-4">
                <span class="text-white font-bold text-2xl">D</span>
    </div>
            <h1 class="text-5xl font-bold text-gray-900">
                <span class="text-primary-600">Derm</span><span class="text-gray-900">AI</span>
            </h1>
        </div>
        <p class="text-xl text-gray-600 font-medium">Professional Skin Care AI</p>
    </div>
</div>

<div th:replace="fragments/navbar :: navbar"></div>

<!-- Professional Hero Section -->
<section class="relative bg-gradient-to-br from-gray-50 to-gray-100 py-20 lg:py-32">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid lg:grid-cols-2 gap-12 items-center">
            <!-- Content -->
            <div class="space-y-8">
                <div class="space-y-4">
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 leading-tight">
                        Yapay Zeka ile
                        <span class="text-primary-600">Cilt Analizi</span>
                    </h1>
                    <p class="text-xl text-gray-600 leading-relaxed">
                        Fotoğrafınızı yükleyin ve anında profesyonel cilt analizi alın. AI'mız kişiselleştirilmiş öneriler ve erken tespit sağlar.
                    </p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="document.getElementById('chat-section').scrollIntoView({ behavior: 'smooth' });" 
                            class="bg-primary-600 hover:bg-primary-700 text-white px-8 py-4 rounded-lg font-semibold text-lg transition-all duration-200 transform hover:scale-105">
                        Analizi Başlat
                    </button>
                 
                </div>
            </div>
            
            <!-- Visual -->
            <div class="relative">
                <div class="bg-white rounded-2xl shadow-2xl p-8 transform rotate-3 hover:rotate-0 transition-transform duration-300">
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">AI Analysis Active</span>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <div class="animate-pulse space-y-2">
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                                <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">Processing...</span>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-primary-500 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-primary-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-primary-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Professional Chat Section -->
<section id="chat-section" class="bg-white py-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid lg:grid-cols-4 gap-8">
            <!-- Chat History Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-gray-50 rounded-xl p-6 h-fit">
                    <div class="mb-6">
                        <button class="w-full bg-primary-600 hover:bg-primary-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span>Yeni Konuşma</span>
                        </button>
      </div>
                    
                    <div class="space-y-2">
                        <div class="flex items-center space-x-3 p-3 bg-primary-100 rounded-lg">
                            <div class="w-2 h-2 bg-primary-600 rounded-full"></div>
                            <span class="text-sm font-medium text-primary-700">Cilt Analizi</span>
        </div>
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors duration-200">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-sm text-gray-600">Sivilce Sorusu</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors duration-200">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-sm text-gray-600">Leke Tavsiyesi</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors duration-200">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-sm text-gray-600">Genel Bilgi</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="lg:col-span-3">
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
                    <!-- Chat Header -->
                    <div class="border-b border-gray-200 p-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">DermAI Asistanı</h3>
                                <p class="text-sm text-gray-500">Profesyonel cilt analizi</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="h-96 overflow-y-auto p-6" id="chat-history">
                        <!-- Messages will be added here -->
                    </div>

                    <!-- Chat Input -->
                    <div class="border-t border-gray-200 p-6">
                        <form autocomplete="off" id="chatbot-form" class="flex items-center space-x-4">
                            <button type="button" id="add-photo-btn" class="p-3 text-gray-400 hover:text-primary-600 transition-colors duration-200" title="Add photo">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
            </button>
                            
                            <img id="chat-image-preview" class="w-12 h-12 object-cover rounded-lg hidden">
                            
                            <div class="flex-1">
                                <input autocomplete="off" id="chat-user-message" maxlength="200" 
                                       placeholder="Mesajınızı yazın..." type="text"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all duration-200">
                            </div>
                            
                            <button type="submit" class="p-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors duration-200" title="Send">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                            
            <input accept="image/*" hidden id="chat-image-input" type="file">
        </form>
                        
                        <div id="chatbot-error" class="mt-3 text-sm text-red-600 hidden"></div>
            </div>
                </div>
            </div>
        </div>
    </div>
</section>
        
        <!-- Professional Photo Choice Modal -->
        <div id="photo-choice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-8">
              <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Fotoğraf Ekle</h3>
              <p class="text-gray-600">Analiz için fotoğrafınızı ekleyin</p>
            </div>
            
            <div class="space-y-4">
              <button id="choose-photo-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white px-6 py-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>Fotoğraf Seç</span>
              </button>
              
              <button id="take-photo-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Fotoğraf Çek</span>
              </button>
              
              <button id="photo-choice-cancel" class="w-full bg-red-50 hover:bg-red-100 text-red-600 px-6 py-4 rounded-lg font-medium transition-colors duration-200">
                Vazgeç
              </button>
            </div>
          </div>
        </div>

        <!-- Professional Photo Warning Modal -->
        <div id="photo-warning-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
              <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Fotoğraf Çekmeden Önce</h3>
              <p class="text-gray-600">Daha iyi analiz için bu önerileri dikkate alın</p>
            </div>
            
            <div class="space-y-4 mb-6">
              <div class="flex items-start space-x-3">
                <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                  <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <span class="text-gray-700">Işıklı bir ortamda olun</span>
              </div>
              <div class="flex items-start space-x-3">
                <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                  <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <span class="text-gray-700">Yüzünüz kameraya düz bakmalı</span>
              </div>
              <div class="flex items-start space-x-3">
                <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                  <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <span class="text-gray-700">Arka plan sade olmalı</span>
              </div>
            </div>
            
            <div class="flex space-x-4">
              <button id="photo-warning-continue" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                Tamam
              </button>
              <button id="photo-warning-cancel" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                Vazgeç
              </button>
            </div>
          </div>
        </div>

        <!-- Professional Camera Modal -->
        <div id="photo-camera-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
              <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Kameradan Fotoğraf Çek</h3>
              <p class="text-gray-600">Analiz için fotoğrafınızı çekin</p>
            </div>
            
            <div class="mb-6">
              <video id="camera-stream" autoplay playsinline class="w-full h-64 object-cover rounded-lg border border-gray-200"></video>
            </div>
            
            <div class="flex space-x-4">
              <button id="capture-photo" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Fotoğrafı Çek</span>
              </button>
              <button id="photo-camera-close" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                Kapat
              </button>
            </div>
          </div>
        </div>
    </div>
</section>

<div class="main-content" id="mainContent">

</div>

<script>
    // Professional splash screen
    if (!sessionStorage.getItem('splashShown')) {
      document.getElementById('splash').classList.remove('hidden');
      setTimeout(function() {
        document.getElementById('splash').classList.add('opacity-0');
        setTimeout(function() {
          document.getElementById('splash').classList.add('hidden');
        }, 500);
        sessionStorage.setItem('splashShown', 'true');
      }, 2000);
    } else {
      document.getElementById('splash').classList.add('hidden');
    }

    function scrollToChat() {
      document.getElementById('chat-section').scrollIntoView({ behavior: 'smooth' });
    }
</script>

<script>
    const chatForm = document.getElementById('chatbot-form');
    const chatInput = document.getElementById('chat-user-message');
    const chatHistory = document.getElementById('chat-history');
    const chatError = document.getElementById('chatbot-error');
    const chatImageInput = document.getElementById('chat-image-input');
    const chatImagePreview = document.getElementById('chat-image-preview');
    let imageDataUrl = null;
    
    chatImageInput.addEventListener('change', function() {
      if (chatImageInput.files.length > 0) {
        const file = chatImageInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          imageDataUrl = e.target.result;
          // Önizleme için resmi göster
          chatImagePreview.src = imageDataUrl;
          chatImagePreview.classList.remove('hidden');
          // Konsola base64'ün ilk 100 karakterini yaz
          console.log("imageDataUrl:", imageDataUrl.substring(0, 100));
        };
        reader.readAsDataURL(file);
      } else {
        imageDataUrl = null;
        chatImagePreview.src = "";
        chatImagePreview.classList.add('hidden');
      }
    });
    
    // Mesaj gönderme
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      chatError.textContent = "";

      const userMessage = chatInput.value.trim();
      if (!userMessage && !imageDataUrl) {
        chatError.textContent = "Lütfen bir mesaj yazın veya fotoğraf ekleyin.";
        return;
      }

      addMessageBubble('user', userMessage, imageDataUrl);
      const loadingBubble = addMessageBubble('ai', '', null, `
        <div class="flex items-center space-x-3 p-2">
          <div class="relative">
            <div class="animate-spin rounded-full h-6 w-6 border-2 border-gray-200"></div>
            <div class="animate-spin rounded-full h-6 w-6 border-2 border-primary-600 border-t-transparent absolute top-0 left-0"></div>
          </div>
          <div class="flex flex-col">
            <span class="text-sm font-medium text-gray-700">Analiz ediliyor...</span>
            <span class="text-xs text-gray-500">AI cildinizi inceliyor</span>
          </div>
        </div>
      `);

      if (imageDataUrl) {
        // 1. Flask API ile hastalık tahmini
        fetch('/api/skin/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageDataUrl })
        })
        .then(res => res.json())
        .then(diseaseData => {
          if (diseaseData.error) {
            loadingBubble.remove();
            addMessageBubble('ai', 'Üzgünüm, analiz yapılamadı.');
            return;
          }
          // 1. En üstte hastalık ve açıklaması
          let diseaseMsg = `DermAI sizde ${diseaseData.description}olduğunu tahmin ediyor.`;
          addMessageBubble('ai', '', null, diseaseMsg);

          // 2. Gemini'den hastalıkla ilgili kısa bilgi ve teşvik
          let geminiPrompt = `Bir cildiyecisin. Kullanıcıda "${diseaseData.description}" (${diseaseData.diagnosis.toUpperCase()}) olduğu tahmin ediliyor. Bu hastalık hakkında kısa, 1-2 cümlelik bilgiler ver ve doktora gitmeliyse teşvik et. Sadece Türkçe yaz.`;
          fetch('/api/gemini/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: geminiPrompt })
          })
          .then(res => res.text())
          .then(geminiDiseaseText => {
            addMessageBubble('ai', geminiDiseaseText);

            // 3. Gemini'den cilt tipi analizi ve ürün önerisi
            let skinPrompt = `Aşağıda bir kullanıcının cilt fotoğrafı ve/veya mesajı var.
Sen bir dermatoloji uzmanı gibi davran ve detaylı bir cilt analizi yap.
Cevabına “Senin cilt tipin: [Cilt Tipi]” başlığıyla başla.
Devamında, cilt sağlığı açısından yorumla ve doktora görünmeli mi açıkla.
En sonda, günlük bakım ve dikkat edilmesi gerekenler için kısa öneriler ekle.
Cevabını sadece Türkçe ve doğal, açıklayıcı bir dille yaz. Gereksiz tekrar ve madde işareti kullanma.`;
            if (userMessage) {
              skinPrompt += `\n\nKullanıcı mesajı: ${userMessage}`;
            }
            if (imageDataUrl) {
              skinPrompt += `\n\nFotoğrafı analiz et.`;
            }
            fetch('/api/gemini/ask', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: skinPrompt, image: imageDataUrl })
            })
            .then(res => res.text())
            .then(data => {
              loadingBubble.remove();
              const formatted = formatAiResponse(data);
              const aiBubble = addMessageBubble('ai', '', null, formatted);
              let aiText = typeof data === "string" ? data : (data.candidates?.[0]?.content?.parts?.[0]?.text || "");
              const skinType = extractSkinTypeFromRaw(aiText);
              console.log('Çıkarılan cilt tipi:', skinType);
              if (skinType) {
                suggestProductsAfterAi(skinType, aiBubble);
              } else {
                console.error('Cilt tipi çıkarılamadı, AI metni:', aiText);
              }
              // Formu temizle
              chatInput.value = "";
              chatImageInput.value = "";
              chatImagePreview.src = "";
              chatImagePreview.classList.add('hidden');
              imageDataUrl = null;
            });
          });
        });
      }

      // Sadece metin varsa, doğrudan cilt tipi analizi ve ürün önerisi yap
      else {
        // Gemini'den cilt tipi analizi
        let skinPrompt = `Aşağıda bir kullanıcının cilt sorunu var.
Sen bir dermatoloji uzmanı gibi davran ve detaylı bir cilt analizi yap.
Cevabına "Senin cilt tipin: [Cilt Tipi]" başlığıyla başla.
Devamında, cilt sağlığı açısından yorumla ve doktora görünmeli mi açıkla.
En sonda, günlük bakım ve dikkat edilmesi gerekenler için kısa öneriler ekle.
Cevabını sadece Türkçe ve doğal, açıklayıcı bir dille yaz. Gereksiz tekrar ve madde işareti kullanma.

Kullanıcı mesajı: ${userMessage}`;

        fetch('/api/gemini/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: skinPrompt })
        })
        .then(res => res.text())
        .then(data => {
          loadingBubble.remove();
          const formatted = formatAiResponse(data);
          const aiBubble = addMessageBubble('ai', '', null, formatted);
          let aiText = typeof data === "string" ? data : (data.candidates?.[0]?.content?.parts?.[0]?.text || "");
          const skinType = extractSkinTypeFromRaw(aiText);
          console.log('Çıkarılan cilt tipi (sadece metin):', skinType);
          if (skinType) {
            suggestProductsAfterAi(skinType, aiBubble);
          } else {
            console.error('Cilt tipi çıkarılamadı, AI metni:', aiText);
          }
          // Formu temizle
          chatInput.value = "";
          chatImageInput.value = "";
          chatImagePreview.src = "";
          chatImagePreview.classList.add('hidden');
          imageDataUrl = null;
        })
        .catch(error => {
          loadingBubble.remove();
          addMessageBubble('ai', 'Üzgünüm, analiz yapılamadı.');
          console.error('Gemini API hatası:', error);
        });
      }
    });
    
    // Professional message bubble function
    function addMessageBubble(sender, text, imgUrl = null, htmlContent = null) {
      const bubble = document.createElement('div');
      
      if (sender === 'user') {
        bubble.className = 'flex justify-end mb-4';
        bubble.innerHTML = `
          <div class="max-w-xs lg:max-w-md bg-primary-600 text-white rounded-2xl rounded-br-md px-4 py-3">
            ${imgUrl ? `<img src="${imgUrl}" alt="Uploaded photo" class="w-full h-32 object-cover rounded-lg mb-2">` : ''}
            ${htmlContent ? htmlContent : (text ? `<p class="text-sm">${text}</p>` : '')}
          </div>
        `;
      } else {
        bubble.className = 'flex justify-start mb-4';
        bubble.innerHTML = `
          <div class="max-w-xs lg:max-w-md bg-gray-100 text-gray-900 rounded-2xl rounded-bl-md px-4 py-3 bubble-content">
            ${imgUrl ? `<img src="${imgUrl}" alt="AI analysis" class="w-full h-32 object-cover rounded-lg mb-2">` : ''}
            ${htmlContent ? htmlContent : (text ? `<p class="text-sm">${text}</p>` : '')}
          </div>
        `;
      }
    
      chatHistory.appendChild(bubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      
      return bubble;
    }
</script>

<script>
function formatAiResponse(rawData) {
  console.log("AI rawData:", rawData); // Debug için

  let text = rawData;
  let isError = false;
  let errorMsg = "";

  try {
    const obj = typeof rawData === "string" ? JSON.parse(rawData) : rawData;
    if (obj.error && obj.error.message) {
      isError = true;
      errorMsg = obj.error.message;
    } else if (obj.candidates && obj.candidates[0]?.content?.parts[0]?.text) {
      text = obj.candidates[0].content.parts[0].text;
    } else {
      text = typeof rawData === "string" ? rawData : JSON.stringify(rawData);
    }
  } catch (e) {
    // Eğer JSON parse edilemiyorsa, düz metin olarak bırak
    text = rawData;
  }

  if (isError) {
    return `<div class="ai-result-error">
      <b>Üzgünüz, yapay zeka şu anda yanıt veremiyor.</b><br>
      <span style="font-size:1.05em;">${errorMsg}</span>
    </div>`;
  }

  // Cilt tipi başlığını yakala ve özel kutuya al, uygun emoji ekle
  text = text.replace(
    /^Senin cilt tipin: ([^\n!]+)!?/im,
    (match, p1) => {
      let skinType = p1.trim().toLowerCase();
      let emoji = "";
      if (skinType.includes("yağlı")) emoji = "💧";
      else if (skinType.includes("kuru")) emoji = "🌵";
      else if (skinType.includes("karma")) emoji = "🍃";
      else if (skinType.includes("hassas")) emoji = "🌸";
      else if (skinType.includes("normal")) emoji = "😊";
      else emoji = "🧴";
      return `<div class="ai-skin-type-highlight">${emoji} Senin cilt tipin: <span>${p1.toUpperCase()}</span></div>`;
    }
  );

  // Anahtar kelimelere emoji ekle ve vurgula
  const keywordEmojis = [
    { word: "sivilce", emoji: "🔴" },
    { word: "leke", emoji: "🟤" },
    { word: "normal", emoji: "😊" },
    { word: "güneş koruyucu", emoji: "☀️" },
    { word: "temizlemelisin", emoji: "🧼" },
    { word: "nemlendirici", emoji: "💧" },
    { word: "doktor", emoji: "🩺" },
    { word: "gözenek", emoji: "🔬" },
    { word: "yağlı", emoji: "💧" },
    { word: "kuru", emoji: "🌵" },
    { word: "karma", emoji: "🍃" },
    { word: "hassas", emoji: "🌸" },
    { word: "temizlik", emoji: "🧼" }
  ];
  keywordEmojis.forEach(({ word, emoji }) => {
    const regex = new RegExp(`\\b(${word})\\b`, "gi");
    text = text.replace(regex, `<span class=\"highlight\">$1 ${emoji}</span>`);
  });

  // AI cevabının başına genel bir emoji ekle
  text = `🤖<br>` + text;

  // Sağlık paragrafının başına sağlık emojisi ekle
  // Paragrafları ayır (iki veya daha fazla \n ile)
  let paragraphs = text.split(/\n{2,}/);
  if (paragraphs.length > 1) {
    // Eğer zaten emoji yoksa başına ekle
    if (!/^([🩺❤️‍🩹🏥💊])/.test(paragraphs[1].trim())) {
      paragraphs[2] = '🩺 ' + paragraphs[1].trim();
    }
  }
  text = paragraphs.join("\n\n");

  return `<div class="ai-result">${text.replace(/\n/g, "<br>")}</div>`;
}

// Kullanım:
const aiRaw = `Senin cilt tipin: Yağlı!
Gözeneklerin geniş ve parlak görünüyor.
Siyah nokta ve sivilceye yatkınlık var.
Cildini günde 2 kez nazikçe temizlemelisin.
Hafif, yağsız nemlendirici kullanmalısın.
Güneş koruyucu ihmal edilmemeli.`;

// document.getElementById('ai-result').innerHTML = formatAiResponse(aiRaw); // Bu satırı kaldır
</script>
<script>
  // Cilt tipini AI cevabından çekmek için yardımcı fonksiyon
function extractSkinTypeFromHtml(html) {
  // AI cevabında <div class="ai-skin-type-highlight">...<span>...</span></div> var
  const match = html.match(/ai-skin-type-highlight[^>]*>[^<]*<span>([^<]+)<\/span>/i);
  if (match) {
    return match[1].toLowerCase();
  }
  return null;
}

function extractSkinTypeFromRaw(aiText) {
  // Türkçe cilt tipi başlığını yakala
  const match = aiText.match(/Senin cilt tipin: ([^\n!]+)!?/i);
  if (match) {
    return match[1].trim().toLowerCase();
  }
  return null;
}

// Cilt tipini İngilizceye çevir
function mapSkinTypeToApi(skinType) {
  const map = {
    'yağlı': 'oily',
    'kuru': 'dry',
    'combination': 'combination',
    'normal': 'normal',
    'sensitive': 'sensitive'
  };
  return map[skinType] || 'all';
}

// Ürünleri gösteren fonksiyon
function showProductCards(products, aiBubble) {
  console.log('showProductCards çağrıldı, ürün sayısı:', products.length);
  console.log('aiBubble:', aiBubble);
  
  // Eski öneri kutusunu kaldır
  let old = aiBubble.querySelector('.product-slider');
  if (old) old.remove();

  // Ürün yoksa hiçbir şey yapma
  if (!products || products.length === 0) {
    console.log('Ürün bulunamadı');
    return;
  }

  console.log('İlk ürün örneği:', products[0]);

  // Ana slider divi
  const slider = document.createElement('div');
  slider.className = 'product-slider bg-white rounded-lg p-4 mt-4 border border-gray-200';

  // Başlık
  const title = document.createElement('div');
  title.className = 'product-slider-title text-lg font-semibold text-gray-800 mb-3';
  title.textContent = 'Senin için önerilen ürünler';
  slider.appendChild(title);

  // Kartları tutan yatay scroll divi
  const list = document.createElement('div');
  list.className = 'product-slider-list flex space-x-4 overflow-x-auto pb-2';

  products.slice(0, 6).forEach(product => {
    const card = document.createElement('a');
    card.className = 'product-card flex-shrink-0 w-48 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow';
    card.href = product.targetUrl || product.seoUrl || '#';
    card.target = '_blank';

    const img = document.createElement('img');
    img.src = product.heroImage || product.imageUrl || '/image/default-product.png';
    img.alt = product.displayName || product.name || '';
    img.className = 'w-full h-32 object-cover rounded-t-lg';
    card.appendChild(img);

    const content = document.createElement('div');
    content.className = 'p-3';

    const name = document.createElement('div');
    name.className = 'product-name text-sm font-medium text-gray-900 mb-1';
    name.textContent = product.displayName || product.name || '';
    content.appendChild(name);

    if (product.brandName) {
      const brand = document.createElement('div');
      brand.className = 'product-brand text-xs text-gray-500';
      brand.textContent = product.brandName;
      content.appendChild(brand);
    }

    card.appendChild(content);
    list.appendChild(card);
  });

  slider.appendChild(list);

  // AI balonunun içine ekle
  const bubbleContent = aiBubble.querySelector('.bubble-content');
  console.log('bubbleContent bulundu mu:', !!bubbleContent);
  if (bubbleContent) {
    bubbleContent.appendChild(slider);
    console.log('Ürün slider eklendi');
  } else {
    console.error('bubble-content bulunamadı');
    console.log('aiBubble HTML:', aiBubble.innerHTML);
  }
}

// AI cevabı geldikten sonra ürün önerisi çek
async function suggestProductsAfterAi(skinType, aiBubble) {
  console.log('suggestProductsAfterAi çağrıldı, cilt tipi:', skinType);
  
  if (!skinType) {
    console.error('Cilt tipi bulunamadı!');
    return;
  }

  // Ürün önerisi için loading ekle
  const productLoadingBubble = addMessageBubble('ai', '', null, `
    <div class="flex items-center space-x-3 p-2">
      <div class="relative">
        <div class="animate-spin rounded-full h-5 w-5 border-2 border-gray-200"></div>
        <div class="animate-spin rounded-full h-5 w-5 border-2 border-primary-600 border-t-transparent absolute top-0 left-0"></div>
      </div>
      <div class="flex flex-col">
        <span class="text-sm font-medium text-gray-700">Ürün önerileri hazırlanıyor...</span>
        <span class="text-xs text-gray-500">Sephora'dan en iyi ürünler aranıyor</span>
      </div>
    </div>
  `);

  const apiSkinType = mapSkinTypeToApi(skinType); // Türkçeden İngilizceye çevir
  console.log('API için cilt tipi:', apiSkinType);
  
  const skinTypeToQuery = {
    'oily': 'oily skin care',
    'dry': 'dry skin care',
    'combination': 'combination skin care',
    'normal': 'normal skin care',
    'sensitive': 'sensitive skin care'
  };
  const queries = [
    `${apiSkinType} skin care`,
    `${apiSkinType} skin moisturizer`,
    `${apiSkinType} skin serum`,
    `${apiSkinType} skin cleanser`
  ];
  const query = queries[Math.floor(Math.random() * queries.length)];
  const randomPage = Math.floor(Math.random() * 5) + 1; // 1-5 arası
  
  // Backend proxy kullan - test endpoint'ini kullan
  const url = `/api/sephora/test`;

  try {
    console.log('Ürün önerisi için istek atılıyor:', url);
    const response = await fetch(url);
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      console.error('HTTP hatası:', response.status, response.statusText);
      showProductCards([], aiBubble);
      return;
    }
    
    const result = await response.json();
    console.log('API yanıtı:', result);
    
    if (result.error) {
      console.error('Sephora API hatası:', result.error);
      showProductCards([], aiBubble);
      return;
    }
    
    const products = result.products || result.data?.products || result.data || [];
    console.log('Bulunan ürün sayısı:', products.length);
    console.log('Ürünler:', products);
    
    // Loading'i kaldır
    if (productLoadingBubble) {
      productLoadingBubble.remove();
    }
    
    showProductCards(products, aiBubble);
  } catch (error) {
    console.error('Ürün önerisi alınamadı:', error);
    
    // Loading'i kaldır
    if (productLoadingBubble) {
      productLoadingBubble.remove();
    }
    
    showProductCards([], aiBubble);
  }
}

// AI cevabı eklenirken bu fonksiyonu çağır
// addMessageBubble fonksiyonunda, AI cevabı ekledikten hemen sonra:
//const aiBubble = addMessageBubble('ai', '', null, formatted);
suggestProductsAfterAi(skinType, aiBubble);
</script>
<script src="/js/app.js"></script>
<script>  // Fotoğrafı analiz ettir
  // Bu kod, chat formunun submit event'inde olmalı.
  // imageDataUrl dolu değilse hiçbir şey olmuyor.
  if (imageDataUrl) {
    fetch('/api/skin/predict', { // veya /api/ai/diagnose, hangisi varsa
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imageDataUrl })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        addMessageBubble('ai', 'Üzgünüm, analiz yapılamadı.');
        return;
      }
      let message = `Tahmin edilen hastalık: <b>${data.diagnosis.toUpperCase()}</b><br>${data.description}`;
      let extra = '';
      if (data.diagnosis === 'mel') {
        extra = '<br><b>Uyarı:</b> Melanom ciddi bir cilt kanseri türüdür, lütfen bir dermatoloğa başvurun!';
      } else if (data.diagnosis === 'bcc') {
        extra = '<br><b>Bilgi:</b> Bazal hücreli karsinom genellikle yavaş ilerler, yine de doktor kontrolü önemlidir.';
      } else if (data.diagnosis === 'nv') {
        extra = '<br><b>Bilgi:</b> Melanositik nevüsler genellikle iyi huyludur, ancak değişiklik gözlemlerseniz doktora danışın.';
      }
      addMessageBubble('ai', null, null, message + extra);
    })
    .catch(err => {
      addMessageBubble('ai', 'Üzgünüm, analiz yapılamadı.');
    });
  }
</script>

<div th:replace="fragments/footer :: footer"></div>

</body>
</html>
