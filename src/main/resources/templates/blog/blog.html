<!DOCTYPE html>
<html lang="tr"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Blog - Cilt Sorunlarƒ± ve √ñneriler</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/layer.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/blog.css}">
    <link rel="stylesheet" th:href="@{/css/toast.css}">
    <script defer th:src="@{/js/toast.js}"></script>

    <style>
        /* x-cloak ile i≈üaretlenmi≈ü her ≈üeyi Alpine ba≈üladƒ±ƒüƒ±nda gizle */
        [x-cloak] { display: none !important; }
    </style>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>

<div th:replace="fragments/navbar :: navbar"></div>
<div th:replace="fragments/messages :: messages"></div>

<div class="main-content show">
    <div class="blog-container">
        <h1>Blog</h1>
        <section class="blog-share" th:if="${isAuthenticated}">
            <h2>Ne payla≈ümak istersin?</h2>
            <form class="blog-form"
                  id="blogForm"
                  method="post"
                  th:action="@{/blog/posts}"
                  th:object="${postRequest}">

                <div>
                    <label for="title">Ba≈ülƒ±k</label>
                    <input id="title"
                           placeholder="Ba≈ülƒ±k"
                           required
                           th:field="*{title}"
                           type="text"/>
                </div>

                <div>
                    <label for="content">ƒ∞√ßerik</label>
                    <textarea id="content"
                              placeholder="Cilt sorununu veya √∂nerini yaz..."
                              required
                              rows="4"
                              th:field="*{content}"></textarea>
                </div>

                <button id="submitPost" type="submit">Payla≈ü</button>
            </form>
        </section>

        <!-- Payla≈üƒ±mlar -->
        <section class="blog-posts">
            <h2>Payla≈üƒ±mlar</h2>

            <!-- Hi√ß post yoksa -->
            <div th:if="${posts.empty}">
                <p>Hen√ºz payla≈üƒ±m yok. ƒ∞lk payla≈üƒ±mƒ± sen yap!</p>
            </div>

            <!-- Post listesi -->
            <div class="blog-post" th:each="post : ${posts.content}" x-data="{ open: false }">
                <div class="post-header">
                    <span class="post-author" th:text="${post.authorUsername}">Yazar</span>
                    <span class="post-date"
                          th:text="${#temporals.format(post.createdAt, 'dd MMMM yyyy')}">
                    </span>

                    <!-- sadece post‚Äôun yazarƒ±ysa g√∂ster -->
                    <button
                            @click="open = true"
                            class="delete-btn btn-danger"
                            th:if="${currentUsername != null and currentUsername == post.authorUsername}">
                        Payla≈üƒ±mƒ±mƒ± Sil
                    </button>

                    <!-- silme modal‚Äôƒ± da aynƒ± ko≈üulun i√ßinde kalƒ±r -->
                    <div class="modal-overlay" x-cloak x-show="open">
                        <div @click.away="open = false" class="modal-content">
                            <div class="modal-header">
                                <h3>Silme Onayƒ±</h3>
                                <button @click="open = false" class="modal-close">√ó</button>
                            </div>
                            <p>Bu yazƒ±yƒ± silmek istediƒüinize emin misiniz?</p>
                            <div class="modal-footer">
                                <button @click="open = false" class="btn-cancel">Vazge√ß</button>
                                <form method="post" th:action="@{/blog/posts/{id}/delete(id=${post.id})}">
                                    <input sec:csrfInput type="hidden"/>
                                    <button class="btn-delete" type="submit">Sil</button>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="post-content">
                    <h3 th:text="${post.title}"></h3>
                    <p th:text="${post.content}"></p>
                </div>

                <div class="post-actions">
                    <!-- üëç Like -->
                    <form class="inline-form"
                          method="post"
                          th:action="@{/blog/posts/{id}/reactions(id=${post.id})}"
                          th:if="${isAuthenticated}">
                        <input sec:csrfInput type="hidden"/>
                        <input name="type" type="hidden" value="LIKE"/>
                        <button type="submit">
                            ‚ù§Ô∏è <span th:text="${post.likeCount}">0</span>
                        </button>
                    </form>

                    <!-- üëé Dislike -->
                    <form class="inline-form"
                          method="post"
                          th:action="@{/blog/posts/{id}/reactions(id=${post.id})}"
                          th:if="${isAuthenticated}">
                        <input sec:csrfInput type="hidden"/>
                        <input name="type" type="hidden" value="DISLIKE"/>
                        <button type="submit">
                            üëé <span th:text="${post.dislikeCount}">0</span>
                        </button>
                    </form>
                </div>

                <!-- Yorumlar -->
                <div class="post-comments">
                    <div class="comment" th:each="cmt : ${post.comments}">
                        <div class="comment-header">
                            <span class="comment-author" th:text="${cmt.authorUsername}">Yorumcu</span>
                            <span class="comment-date"
                                  th:text="${#temporals.format(cmt.createdAt, 'dd MMM yyyy HH:mm')}">
                            </span>

                            <!-- sadece post sahibi veya yorum sahibi g√∂rs√ºn -->
                            <form class="comment-delete-form"
                                  method="post"
                                  th:action="@{/blog/posts/{postId}/comments/{commentId}/delete(postId=${post.id}, commentId=${cmt.id})}"
                                  th:if="${currentUsername == post.authorUsername or currentUsername == cmt.authorUsername}">
                                <input sec:csrfInput type="hidden"/>
                                <button class="btn-comment-delete" type="submit">Yorumu Kaldƒ±r</button>
                            </form>
                        </div>

                        <div class="comment-body">
                            <p th:text="${cmt.content}"></p>
                        </div>

                        <!-- yorum reaksiyonlarƒ± -->
                        <div class="comment-actions" th:if="${isAuthenticated}">
                            <!-- üëç Like -->
                            <form method="post"
                                  th:action="@{/blog/posts/{postId}/comments/{commentId}/reactions(postId=${post.id},commentId=${cmt.id})}">
                                <input sec:csrfInput type="hidden"/>
                                <input name="type" type="hidden" value="LIKE"/>
                                <button type="submit">
                                    ‚ù§Ô∏è<span th:text="${cmt.likeCount}">0</span>
                                </button>
                            </form>

                            <!-- üëé Dislike -->
                            <form method="post"
                                  th:action="@{/blog/posts/{postId}/comments/{commentId}/reactions(postId=${post.id},commentId=${cmt.id})}">
                                <input sec:csrfInput type="hidden"/>
                                <input name="type" type="hidden" value="DISLIKE"/>
                                <button type="submit">
                                    üëé<span th:text="${cmt.dislikeCount}">0</span>
                                </button>
                            </form>
                        </div>


                    </div>

                    <form class="comment-form"
                          method="post"
                          th:action="@{/blog/posts/{id}/comments(id=${post.id})}"
                          th:object="${commentRequest}">
                        <input sec:csrfInput type="hidden"/>

                        <input placeholder="Yorumunuzu yazƒ±n"
                               required
                               th:field="*{content}"
                               type="text"/>
                        <button type="submit">G√∂nder</button>
                    </form>
                </div>

            </div>
        </section>
    </div>

    <!-- Sayfalama -->
    <div class="pagination"
         th:if="${posts.totalPages > 1}">
        <a th:href="@{/blog(page=${posts.number-1},size=${posts.size})}"
           th:if="${posts.hasPrevious()}">
            ¬´ Geri
        </a>
        <span th:text="${posts.number + 1} + ' / ' + ${posts.totalPages}"></span>
        <a th:href="@{/blog(page=${posts.number+1},size=${posts.size})}"
           th:if="${posts.hasNext()}">
            ƒ∞leri ¬ª
        </a>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<!--<script th:src="@{/js/app.js}"></script>-->

</body>
</html>